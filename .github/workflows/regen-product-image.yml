name: regen-product-image

on:
  workflow_dispatch:
    inputs:
      product_name:
        description: 'Product name (ARTICULO)'
        required: true
        type: string
      category:
        description: 'Category (optional)'
        required: false
        default: ''
        type: string

jobs:
  regen:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install gspread google-auth

      - name: Write CASABERT prompt file
        run: |
          cat > /tmp/prompt_casabert.txt <<'PROMPT'
          You are generating consistent product packshot images for a brand called CASABERT.

          NON-NEGOTIABLE CONSISTENCY RULES:
          - Always use the same overall photographic style: modern, natural, premium, close-up product photography.
          - Always show a stand-up resealable kraft paper pouch with a transparent window (the product visible inside).
          - Always include a small wooden bowl containing the same product next to the pouch, plus a few scattered pieces/grains as styling.
          - Camera angle: straight-on front view, eye-level, centered composition (pouch on left, bowl on right).
          - Lighting: soft, diffused studio lighting, warm and natural, gentle shadows, high detail.
          - Depth of field: shallow-to-medium (sharp on pouch label + product texture, slightly blurred background).
          - Background must be category-color-coded: not necessarily a flat color, but clearly dominated by one recognizable hue (a textured backdrop).
          - Add a subtle watermark: the CASABERT text + a small shell-like logo watermark, semi-transparent, placed on the right side background.
          - Also add a very subtle CASABERT watermark centered near the bottom (semi-transparent).
          - NO people, NO hands, NO extra objects unrelated to the product.
          - Do NOT invent or rename products. The product name must match exactly the provided PRODUCT_NAME in ALL CAPS.
          - The pouch label must include:
            1) PRODUCT_NAME in ALL CAPS
            2) The CATEGORY name (exact)
            3) CASABERT brand name
          - Image must look like a real high-end product photo.
          - Output: a single square image (1:1), high resolution, crisp details.

          PRODUCT BRIEF:
          - PRODUCT_NAME (ALL CAPS): {PRODUCT_NAME}
          - CATEGORY (exact): {CATEGORY}
          - CATEGORY_BACKGROUND_COLOR_DIRECTION: {BACKGROUND_COLOR_DIRECTION}
          - PRODUCT_VISUAL: {PRODUCT_VISUAL}

          SHOT DESCRIPTION:
          Create a premium close-up product photograph following the CASABERT consistency rules.
          Show a resealable kraft pouch with a transparent window filled with {PRODUCT_VISUAL}.
          Place a wooden bowl filled with {PRODUCT_VISUAL} to the right.
          Scatter a small amount of {PRODUCT_VISUAL} on the surface in front.
          Use a textured background dominated by {BACKGROUND_COLOR_DIRECTION}.
          Ensure the label text is exactly:
          - {PRODUCT_NAME}
          - {CATEGORY}
          - CASABERT
          Add subtle CASABERT + shell logo watermark on the right background and a subtle CASABERT watermark near the bottom center.
          PROMPT

      - name: Regenerate one image + update sheet URL/IMAGE
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
        run: |
          python scripts/regen_product_image.py \
            --product-name "${{ github.event.inputs.product_name }}" \
            --category "${{ github.event.inputs.category }}" \
            --sheet-id "1XdMrGB9Je9w-oVj3V0qM-92WNd8TFjmvo0sqG5w_5xc" \
            --sheet-name "GENERAL" \
            --repo-owner "ailidmx" \
            --repo-name "BertClient" \
            --repo-ref "main" \
            --repo-path "img/product" \
            --out-dir "img/product" \
            --prompt-file "/tmp/prompt_casabert.txt"

      - name: Commit & push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add img/product
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "chore: regen image for ${{ github.event.inputs.product_name }}"
          git push origin main
