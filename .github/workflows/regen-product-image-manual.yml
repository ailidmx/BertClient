name: regen-product-image-manual
# refresh: 2026-02-12 to ensure workflow_dispatch registration stays active

on:
  workflow_dispatch:
    inputs:
      product_name:
        description: 'Product name (ARTICULO)'
        required: true
      category:
        description: 'Category (optional)'
        required: false
        default: ''
      chat_id:
        description: 'Telegram chat id to notify (optional)'
        required: false
        default: ''
  repository_dispatch:
    types: [regen_product_image]

jobs:
  regen:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install gspread google-auth

      - name: Write CASABERT prompt file
        run: |
          cat > /tmp/prompt_casabert.txt <<'PROMPT'
          You are generating consistent product packshot images for a brand called CASABERT.

          NON-NEGOTIABLE CONSISTENCY RULES:
          - Always use the same overall photographic style: modern, natural, premium, close-up product photography.
          - Always show a stand-up resealable kraft paper pouch with a transparent window (the product visible inside).
          - Always include a small wooden bowl containing the same product next to the pouch, plus a few scattered pieces/grains as styling.
          - Camera angle: straight-on front view, eye-level, centered composition (pouch on left, bowl on right).
          - Lighting: soft, diffused studio lighting, warm and natural, gentle shadows, high detail.
          - Depth of field: shallow-to-medium (sharp on pouch label + product texture, slightly blurred background).
          - Background must be category-color-coded: not necessarily a flat color, but clearly dominated by one recognizable hue (a textured backdrop).
          - Add a subtle watermark: the CASABERT text + a small shell-like logo watermark, semi-transparent, placed on the right side background.
          - Also add a very subtle CASABERT watermark centered near the bottom (semi-transparent).
          - NO people, NO hands, NO extra objects unrelated to the product.
          - Do NOT invent or rename products. The product name must match exactly the provided PRODUCT_NAME in ALL CAPS.
          - The pouch label must include:
            1) PRODUCT_NAME in ALL CAPS
            2) The CATEGORY name (exact)
            3) CASABERT brand name
          - Image must look like a real high-end product photo.
          - Output: a single square image (1:1), high resolution, crisp details.

          PRODUCT BRIEF:
          - PRODUCT_NAME (ALL CAPS): {PRODUCT_NAME}
          - CATEGORY (exact): {CATEGORY}
          - CATEGORY_BACKGROUND_COLOR_DIRECTION: {BACKGROUND_COLOR_DIRECTION}
          - PRODUCT_VISUAL: {PRODUCT_VISUAL}

          SHOT DESCRIPTION:
          Create a premium close-up product photograph following the CASABERT consistency rules.
          Show a resealable kraft pouch with a transparent window filled with {PRODUCT_VISUAL}.
          Place a wooden bowl filled with {PRODUCT_VISUAL} to the right.
          Scatter a small amount of {PRODUCT_VISUAL} on the surface in front.
          Use a textured background dominated by {BACKGROUND_COLOR_DIRECTION}.
          Ensure the label text is exactly:
          - {PRODUCT_NAME}
          - {CATEGORY}
          - CASABERT
          Add subtle CASABERT + shell logo watermark on the right background and a subtle CASABERT watermark near the bottom center.
          PROMPT

      - name: Notify queued (Telegram)
        env:
          BOT_NOTIFY_URL: ${{ secrets.BOT_NOTIFY_URL }}
          BOT_NOTIFY_TOKEN: ${{ secrets.BOT_NOTIFY_TOKEN }}
          CHAT_ID: ${{ github.event.inputs.chat_id || github.event.client_payload.chat_id || '' }}
          PRODUCT_NAME: ${{ github.event.inputs.product_name || github.event.client_payload.product_name || '' }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ -z "$CHAT_ID" ] || [ -z "$BOT_NOTIFY_URL" ]; then
            echo "Skip queued notify (missing chat_id or BOT_NOTIFY_URL)"
            exit 0
          fi
          curl -sS -G "$BOT_NOTIFY_URL" \
            --data-urlencode "action=regen_notify" \
            --data-urlencode "token=${BOT_NOTIFY_TOKEN}" \
            --data-urlencode "chatId=${CHAT_ID}" \
            --data-urlencode "status=queued" \
            --data-urlencode "productName=${PRODUCT_NAME}" \
            --data-urlencode "runUrl=${RUN_URL}"

      - name: Regenerate one image + update sheet URL/IMAGE
        id: regen
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
          PRODUCT_NAME_INPUT: ${{ github.event.inputs.product_name || github.event.client_payload.product_name || '' }}
          CATEGORY_INPUT: ${{ github.event.inputs.category || github.event.client_payload.category || '' }}
        run: |
          RESULT_JSON="$(python scripts/regen_product_image.py \
            --product-name "${PRODUCT_NAME_INPUT}" \
            --category "${CATEGORY_INPUT}" \
            --sheet-id "1XdMrGB9Je9w-oVj3V0qM-92WNd8TFjmvo0sqG5w_5xc" \
            --sheet-name "GENERAL" \
            --repo-owner "ailidmx" \
            --repo-name "BertClient" \
            --repo-ref "main" \
            --repo-path "img/product" \
            --out-dir "img/product" \
            --prompt-file "/tmp/prompt_casabert.txt")"
          echo "$RESULT_JSON"
          IMAGE_URL="$(python - "$RESULT_JSON" <<'PY'
import json,sys
obj=json.loads(sys.argv[1])
print(obj.get('cdn_url',''))
PY
          )"
          echo "image_url=$IMAGE_URL" >> "$GITHUB_OUTPUT"

      - name: Notify done (Telegram)
        if: success()
        env:
          BOT_NOTIFY_URL: ${{ secrets.BOT_NOTIFY_URL }}
          BOT_NOTIFY_TOKEN: ${{ secrets.BOT_NOTIFY_TOKEN }}
          CHAT_ID: ${{ github.event.inputs.chat_id || github.event.client_payload.chat_id || '' }}
          PRODUCT_NAME: ${{ github.event.inputs.product_name || github.event.client_payload.product_name || '' }}
          IMAGE_URL: ${{ steps.regen.outputs.image_url }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ -z "$CHAT_ID" ] || [ -z "$BOT_NOTIFY_URL" ]; then
            echo "Skip done notify (missing chat_id or BOT_NOTIFY_URL)"
            exit 0
          fi
          curl -sS -G "$BOT_NOTIFY_URL" \
            --data-urlencode "action=regen_notify" \
            --data-urlencode "token=${BOT_NOTIFY_TOKEN}" \
            --data-urlencode "chatId=${CHAT_ID}" \
            --data-urlencode "status=done" \
            --data-urlencode "productName=${PRODUCT_NAME}" \
            --data-urlencode "imageUrl=${IMAGE_URL}" \
            --data-urlencode "runUrl=${RUN_URL}"

      - name: Notify failed (Telegram)
        if: failure()
        env:
          BOT_NOTIFY_URL: ${{ secrets.BOT_NOTIFY_URL }}
          BOT_NOTIFY_TOKEN: ${{ secrets.BOT_NOTIFY_TOKEN }}
          CHAT_ID: ${{ github.event.inputs.chat_id || github.event.client_payload.chat_id || '' }}
          PRODUCT_NAME: ${{ github.event.inputs.product_name || github.event.client_payload.product_name || '' }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ -z "$CHAT_ID" ] || [ -z "$BOT_NOTIFY_URL" ]; then
            echo "Skip failed notify (missing chat_id or BOT_NOTIFY_URL)"
            exit 0
          fi
          curl -sS -G "$BOT_NOTIFY_URL" \
            --data-urlencode "action=regen_notify" \
            --data-urlencode "token=${BOT_NOTIFY_TOKEN}" \
            --data-urlencode "chatId=${CHAT_ID}" \
            --data-urlencode "status=failed" \
            --data-urlencode "productName=${PRODUCT_NAME}" \
            --data-urlencode "error=workflow failed" \
            --data-urlencode "runUrl=${RUN_URL}"

      - name: Commit & push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add img/product
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          PRODUCT_NAME_COMMIT="${{ github.event.inputs.product_name || github.event.client_payload.product_name || 'product' }}"
          git commit -m "chore: regen image for ${PRODUCT_NAME_COMMIT}"
          git push origin main
